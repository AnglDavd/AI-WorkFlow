## Objective
This node is the core of the setup process. It either injects the `.ai_workflow` into an existing project or transforms the current directory into a new project. It also handles `.gitignore` configuration.

## Pre-conditions
- The file `/.ai_workflow/temp_state.vars` must exist and contain `PROJECT_NAME` and `PROJECT_DIR`.
- The user must have confirmed the plan in the previous step.

## Commands
```bash
source ./.ai_workflow/temp_state.vars

# Function to configure .gitignore in a target directory
configure_gitignore() {
    TARGET_DIR=$1
    echo "--- .gitignore Configuration in $TARGET_DIR ---"
    GITIGNORE_FILE="$TARGET_DIR/.gitignore"

    if [ ! -f "$GITIGNORE_FILE" ]; then
        echo "File '$GITIGNORE_FILE' not found. Creating it."
        touch "$GITIGNORE_FILE"
        echo "# Autogenerated by AI Framework Setup" >> "$GITIGNORE_FILE"
    fi

    IGNORE_PATTERN='^\.ai_workflow/?$|^\.gemini_workflow/?$'
    if grep -q -E "$IGNORE_PATTERN" "$GITIGNORE_FILE"; then
        echo "Found rules ignoring the framework directory in .gitignore. Removing them..."
        sed -i.bak -E "/${IGNORE_PATTERN}/d" "$GITIGNORE_FILE"
        rm -f "${GITIGNORE_FILE}.bak"
    else
        echo "No rules found ignoring the framework directory. Configuration is correct."
    fi
    echo "--- End .gitignore Configuration ---"
}


# CASE 1: Injecting into an EXISTING project
if [ -n "$PROJECT_DIR" ] && [ "$PROJECT_DIR" != "." ]; then
    echo "Injecting .ai_workflow into existing project at: $PROJECT_DIR"
    
    # Safety check: ensure the target directory actually exists
    if [ ! -d "$PROJECT_DIR" ]; then
        handle_workflow_error "The specified project directory '$PROJECT_DIR' does not exist."
        exit 1
    fi

    # Copy the framework
    if cp -r .ai_workflow "$PROJECT_DIR/"; then
        echo "Framework successfully copied to $PROJECT_DIR"
    else
        handle_workflow_error "Failed to copy framework to '$PROJECT_DIR'. Check permissions."
        exit 1
    fi

    # Configure .gitignore in the target directory
    configure_gitignore "$PROJECT_DIR"

    # Set a flag for the cleanup step
    echo "export SETUP_MODE='inject'" >> ./.ai_workflow/temp_state.vars


# CASE 2: Transforming this directory into a NEW project
else
    echo "Transforming current directory into a new project named '$PROJECT_NAME'."
    
    # The only structural action needed here is to remove our own git history.
    # The user is already in their desired project directory.
    echo "Removing the installer's Git history..."
    rm -rf .git
    
    # Configure .gitignore in the current directory
    configure_gitignore "."

    # Set a flag for the git initialization step
    echo "export SETUP_MODE='new'" >> ./.ai_workflow/temp_state.vars
fi
```

## Verification Criteria
- If "inject" mode: The `.ai_workflow` directory must exist inside `PROJECT_DIR`, and the `.gitignore` in that directory must be correctly configured.
- If "new" mode: The `.git` directory must be gone from the current directory, and the local `.gitignore` must be correctly configured.

## Next Steps
- **On Success:** Proceed to [Initialize New Git Repository](./04_init_git.md).
- **On Failure:** Proceed to [Generic Error Handler](../../common/error.md).